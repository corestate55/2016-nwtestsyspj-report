%% -*- coding: utf-8-unix -*-

\chapter{関連ソフトウェア}

 \section{Expectacle}
 \label{sec:expectacle}

tftp server – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/documents/268762822}

GitHub - stereocat/expectacle: Simple expect wrapper to send commands to devices. \url{https://github.com/stereocat/expectacle/tree/develop}

\section{Debugging Trema}

謎PacketInで死なずにログを出す – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/todos/221324759}

\begin{itemize}
 \item Tremaのエラーログを出す – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/todos/210777914}
 \item 今日なにした? – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/questions/181826801/answers/2016-09-08#__recording_221236017}
\end{itemize}

send/receive message

\begin{itemize}
 \item 今日なにした? – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/questions/181826801/answers/2016-09-27#__recording_241560820}
 \item 送受信メッセージログ – NetTester \url{https://3.basecamp.com/3088280/buckets/867009/messages/241506055}
\end{itemize}

\section{Phut Basics}
\label{sec:phut_basics}

ここでは、NetTesterの内部実装およびNetTester自身のテストコードで使用され
ているコードを元に、仮想ノード/仮想ネットワーク操作の処理実装の基礎につ
いて解説する。NetTester内部では、Phut\footnote{trema/phut: Virtual
network in seconds \url{https://github.com/trema/phut}}を使用してLinuxの
仮想ネットワーク機能を操作している。なお、記載内容は 2016年9月時点のもの
である。

\subsection{Phutによる仮想ノード/仮想ネットワーク操作の概要}

まず、Phutによる virtual link/host/switch の操作のながれを理解する。
\begin{itemize}
 \item vLink を生成する
 \item vHost/vSwitch を生成する
       \begin{itemize}
        \item PhutではvHost/vSwitch を生成するときに interface device
              (vLinkの端点) を指定するので、通常は先に vLink を生成こと
              になる。
       \end{itemize}
 \item vLink と vHost/vSwitch を接続してトポロジを組み立てる。
\end{itemize}

vLink/vHost/vSwitch のいずれも、インスタンスを使うときは \verb|#create|
method を使用する。(\verb|create| は \verb|new| +
\verb|run|, \verb|start| という形になっている。単純に \verb|new| するだ
けでは active/enable にならない。)

インスタンスを操作したい場合は、インスタンス名(\verb|name| attribute)で
\verb|find_by| する。

\begin{lstlisting}[title=\code{\#find\_by}メソッド利用例]
instance = Phut::<class>.find_by('instance_name')
\end{lstlisting}

\subsection{vLink}

\verb|Phut::Link| で vLink をつくる。これにより、以下のような vLink が作
成される。

\begin{textbox}
\begin{verbatim}
[veth]---------------[veth]
\end{verbatim}
\end{textbox}

これには「Phutで扱うための名前」と「OS上で使われる実際のデバイス名」があ
る。例えば、\verb|Phut::Link('sport', 'dport')|というコードに対しては、
\code{sport}, \code{dport}がPhutで扱うための名前となる。

Phutの内部処理でPhut内部用の名前をもとにOS上でつかわれる実際のデバイス名
(\code{L1\_sport}, \code{L1\_dport})が決められる。OS上(NetTester外)から
Phutで生成したインスタンスを操作する場合は、実際のデバイス名を使用する必
要がある。また、デバイス名として使用できる文字列には上限があるため、名前
(文字列)の長さに注意する必要がある。

\begin{textbox}
\begin{verbatim}
link = Phut::Link('sport', 'dport')

'sport'              'dport'        .... name
[veth]---------------[veth]
'L1_sport'           'L1_dport'     .... device
\end{verbatim}
\end{textbox}

生成した vLink(veth pair)をそのほかのインスタンス(vHost/vSwitch)に接続す
ることで仮想ネットワークを構成する。

\subsection{vHost}
Phutでは2種類のホストを取り扱う。

\paragraph{Phut::Vhost}

Rubyで実装された仮想ノードである。下記のように動作がシンプルで、直接的な
動作チェックに向いている。
\begin{itemize}
 \item UDPパケットの送受信ができる(\verb|#send_packet|)。
       \begin{itemize}
        \item ARPは送信せず、直接 IP(UDP) Unicastを送信する。
       \end{itemize}
 \item ARP処理しないので、あらかじめ ARP table を与えておく必要がある
       (\verb|arp_entries|で ``\verb|IP1/MAC1,IP2/MAC2,...|'' のような文
       字列を与える)。パケット送信(\verb|#send_packet|)するときに ARP
       entry が見つからなければ何もしない(パケットを送信しない)。
\begin{lstlisting}[title=\code{arp\_entries}の例]
arp_entries = "192.168.0.1/00:ba:dc:ab:1e:01,192.168.0.2/00:ba:dc:ab:1e:02"
\end{lstlisting}
\end{itemize}


インスタンスを作るときに、\verb|device| でこのホストに接続する veth を指
定する(\lstref{lst:create-vhost-instance})。
\begin{lstlisting}[caption=Phut::Vhostインスタンスの作成,label=lst:create-vhost-instance]
host = Phut::Vhost.create(name: 'host_name',
                          ip_address: ip_address,
                          mac_address: mac_address,
                          arp_entries: arp_entries,
                          device: link.device('interface_name'))
\end{lstlisting}

\paragraph{Phut::Netns}
Linux namespace で作成したホスト。何らかのコマンド(プロセス)を namespace
上で実行する形をとる。これは、ネットワークのみホストOSから分離した
(namespaceをわけた)状態で、OS上でコマンド実行するのと同様である。実行結
果の処理などは自分で作りこみをする必要があるが、その分自由度がおおきく、
OS上で実行可能な処理は原則そのまま利用できる。

Network Namespace は Linux OS の機能であるため、NetTesterで作成した
namespace であっても、NetTester の外側(OS)から使用可能である\footnote{OS
上で \code{sudo ip netns exec <host namespace> <command>} する。}。

複雑なデバッグ作業をやりたい場合は Netns を使う必要がある。インスタンス
を作ったあと \verb|#device=| でこのホストに接続する veth を指定する
(\lstref{lst:create-netns-instance})。

\begin{lstlisting}[caption=Phut::Netnsインスタンスの作成,label=lst:create-netns-instance]
host = Phut::Netns.create(name: 'host_name',
                          ip_address: ip_address,
                          netmask: '255.255.255.0',
                          mac_address: mac_address)
host.device = link.device('interface_name')
\end{lstlisting}

\subsection{vSwitch}

NetTester自体をテストするためのテストシナリオ
\footnote{\code{features/step\_definitions/net\_tester\_physical\_switch\_steps.rb,
net\_tester\_steps.rb}}実装の中で、NetTester本体の起動では以下のような処
理をしている(\lstref{lst:run-nettester})。
\begin{lstlisting}[caption=NetTesterの起動,label=lst:run-nettester]
 Given(/^DPID が (\S+) の NetTester 物理スイッチ$/) do |dpid|
  @physical_test_switch = PhysicalTestSwitch.create(dpid: dpid.hex)
 end

 Given(/^NetTester を起動$/) do
  main_link = Phut::Link.create('ssw', 'psw')
  NetTester.run(network_device: main_link.device(:ssw),
                physical_switch_dpid: @physical_test_switch.dpid)
  @physical_test_switch.add_numbered_port(1, main_link.device(:psw))
 end
\end{lstlisting}

これにより、次のように仮想ネットワークが構成される。ここでは、NetTester
自身のテストのために、物理スイッチに相当するものをvSwitch(ソフトウェアス
イッチ, \verb|@physical_test_switch|)として起動している。

\begin{textbox}
\begin{verbatim}
@physical_test_switch = PhysicalTestSwitch.create(dpid: dpid.hex)
@physical_test_switch.add_numbered_port(1, main_link.device(:psw))

 +-----------------------+
 | psw (dpid 0x123)      :..............................,
 +--[1]------------------+                              :
     |                                                  :
     |   main_link = Phut::Link.create('ssw', 'psw')    :
     |                                                  :
 +--[1]------------------+                              :   tcp/6653 (default)
 | ssw (dpid 0xdad1c001) :..............................:.. NetTesterController
 +-----------------------+
 NetTester.run(network_device: main_link.device(:ssw),
               physical_switch_dpid: @physical_test_switch.dpid)
\end{verbatim}
\end{textbox}

\verb|NetTester.#run|の中では以下の処理をしている。

\begin{itemize}
 \item trema の起動 (NetTesterControllerの起動)
 \item ssw の起動
 \item ssw に veth (\verb|main_link.device(:ssw)|) を接続する。
       (port number 1)
\end{itemize}

\subsection{テスト対象としての vSwitch の利用}

NetTester 自身をテストする場合、テスト対象ネットワークに相当するものをテ
ストシナリオ中で用意する必要がある。テスト対象として vSwitch を起動する
場合は\lstref{lst:run-vswitch}のようにおこなう
\footnote{\code{features/step\_definitions/ethernet\_switch\_steps.rb}}。
\lstref{lst:run-vswitch}では、テスト対象として使用する vSwitch の起動お
よびコントローラとの接続(Learning Switchとして動作させるため)をおこなっ
ている。

\begin{lstlisting}[caption=vSwitchの起動,label=lst:run-vswitch]
Given(/^テスト対象のイーサネットスイッチ$/) do
  @testee_switch = TesteeSwitch.create(dpid: 0x1, tcp_port: 6654)
  step %(I successfully run `trema run ../../vendor/learning_switch/lib/learning_switch.rb --port 6654 -L #{Phut.log_dir} -P #{Phut.pid_dir} -S #{Phut.socket_dir} --daemon`)
end
\end{lstlisting}

テストシナリオ内部
\footnote{\code{features/step\_definitions/net\_tester\_physical\_switch\_steps.rb}}
では、テスト対象ネットワーク(\verb|@testee_switch|)と物理スイッチ
(\verb|@physical_test_switch|)を接続するため、
\lstref{lst:connect-vswitch}のような処理をおこなう。

\begin{lstlisting}[caption=vSwitch間接続,label=lst:connect-vswitch]
Given(/^NetTester 物理スイッチとテスト対象のスイッチを次のように接続:$/) do |table|
  table.hashes.each do |each|
    pport_id = each['Physical Port'].to_i
    tport_id = each['Testee Port'].to_i
    port_name = "pport#{pport_id}"
    tport_name = "tport#{tport_id}"
    link = Phut::Link.create(tport_name, port_name)
    @physical_test_switch.add_numbered_port(pport_id, link.device(port_name))
    @testee_switch.add_numbered_port(tport_id, link.device(tport_name))
  end
end
\end{lstlisting}

これによって下記のように仮想ネットワークが構成される。

\begin{textbox}
\begin{verbatim}
  +---------------------------+      (tcp/6654)
  | testee_switch (dpid: 0x1) :......(Testee controller)
  +--[tport_id]---------------+
       |
       | Phut::Link.create(tport_name, port_name)
       |
  +--[pport_id]-----------+
  | psw (dpid 0x123)      |
  +--[1]------------------+
      |
     ssw
\end{verbatim}
\end{textbox}

\subsection{テスト対象としての vHost の利用}

\footnote{features/internal\_tests/p2p\_patch.feature}では、テスト対象ネッ
NetTesterのテストシナリオネットワークに属するノードの生成・操作は
\lstref{lst:create-testnode}のように記述している。

\begin{lstlisting}[caption=テスト用ノードの生成,label=lst:create-testnode]
  Background:
    Given DPID が 0x123 の NetTester 物理スイッチ
    And NetTester を起動
    And NetTester 物理スイッチとテスト対象ホストを次のように接続:
      | Physical Port | Host |
      |             2 |    1 |
      |             3 |    2 |
      |             4 |    3 |
\end{lstlisting}

テストシナリオ内部
\footnote{features/step\_definitions/p2p\_patch\_steps.rb}(\lstref{lst:operate-testnode})
では、テストシナリオ(\lstref{lst:create-testnode})であたえられたテスト用
ノードのパラメタを元に以下のようにノードを生成し、テストを実行する。

\begin{lstlisting}[caption=テスト用ノードの生成と操作,label=lst:operate-testnode]
Given(/^NetTester 物理スイッチとテスト対象ホストを次のように接続:$/) do |table|
  ip_of_host = {}
  mac_of_host = {}
  vhost_arp_list = []

  table.hashes.each do |each|
    host_id = each['Host']
    ip_address = "192.168.0.#{host_id}"
    ip_of_host[host_id] = ip_address
    mac_address = "00:ba:dc:ab:1e:#{sprintf('%02x', host_id)}"
    mac_of_host[host_id] = mac_address
    vhost_arp_list.append "#{ip_address}/#{mac_address}"
  end

  arp_entries = vhost_arp_list.join(',')
  table.hashes.each do |each|
    pport_id = each['Physical Port'].to_i
    pport_name = "pport#{pport_id}"
    host_id = each['Host']
    host_name = "host#{host_id}"
    link = Phut::Link.create(host_name, pport_name)
    Phut::Vhost.create(name: host_name,
                       ip_address: ip_of_host[host_id],
                       mac_address: mac_of_host[host_id],
                       device: link.device(host_name),
                       arp_entries: arp_entries)
    @physical_test_switch.add_numbered_port(pport_id, link.device(pport_name))
  end
end
\end{lstlisting}

\lstref{lst:operate-testnode}では\verb|Phut::Vhost|を使用している。すべ
てのテスト用ノードの \verb|arp_entries| を作るために IP/MAC を用意すると
ころと、Phut instance を生成するパートに分割している。これにより、以下の
ように複数のテスト用ノードが作成され、テスト対象ネットワークとして物理ス
イッチ(\verb|psw|)に接続される。

\begin{textbox}
\begin{verbatim}
Phut::Vhost.create(name: host_name,..., device:link.device(host_name))
  +-------------+
  |    hostN    |
  +-----[+]-----+
         |
         | Phut::Link.create(host_name, pport_name)
         |
  +--[pport_id]-----------+
  | psw (dpid 0x123)      |
  +--[1]------------------+
      |
     ssw
\end{verbatim}
\end{textbox}

%%% Local Variables:
%%% mode: yatex
%%% TeX-master: "main.tex"
%%% End:
